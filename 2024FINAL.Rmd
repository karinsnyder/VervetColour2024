---
title: '2024'
output:
  html_document: default
  pdf_document: default
  word_document: default
date: "2024-01-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(repos = c(CRAN = "https://cloud.r-project.org/"))
```


##Load data, remove NAs
```{r}
## Libraries
library(vegan)
library(tidyverse)
library(MuMIn)

## Load data
data <- read.csv("NewData8.csv", stringsAsFactors = FALSE)
data[data == "#VALUE!"] <- NA ## convert Excel errors to NA
data[,15:22] <- apply(data[,15:22], 2, as.numeric)
data$AgeClass <- as.factor(data$AgeClass) ## convert ageclass to factor


## Select response variables
responseVars <- c("BlueLUM","BlueBY","BlueRG","RedLUM","RedBY", "RedRG")


## Select predictor variables
predictorVars<- c( "Age", "Prevalence", "Richness", "GCMEAN", "ARMEAN", "Ordinal")


#Drop AgeClass
data2 <- data[ -c(4) ]

## Drop NA
data3 <- data2[!is.na(data$BlueLUM),]
data4 <- data3[!is.na(data2$Elo),]
data5 <- data4[!is.na(data3$RedLUM),]
data6 <- data5[!is.na(data4$Richness),]


##Load Sociosexual Data

data3 <- read.csv("Data_counts_9Aug.csv", stringsAsFactors = FALSE)

```


##Power analyses Model 1 

```{r}

library(car)  # For Type III ANOVA
library(pwr)  # For power analysis

predictors <- c("BlueLUM", "BlueBY", "BlueRG", "RedLUM", "RedBY", "RedRG")
outcomes <- c("Ordinal", "Prevalence", "Richness", "ARMEAN", "GCMEAN")

power_results <- data.frame(Outcome = character(),
                            Predictor = character(),
                            R2 = numeric(),
                            f2 = numeric(),
                            v = numeric(),  # Degrees of freedom for error term
                            u = numeric(),  # Number of predictors
                            Power = numeric(),
                            stringsAsFactors = FALSE)


alpha <- 0.05  

# Loop over each combination of predictor and outcome
for (outcome in outcomes) {
  for (predictor in predictors) {
    # Fit the linear model for the current combination
    model <- lm(as.formula(paste(outcome, "~", predictor)), data = data6)
    
R2 <- summary(model)$r.squared
    
f2 <- R2 / (1 - R2)
    
df_error <- summary(model)$df[2]
    
numPredictors <- 1  

power_result <- pwr.f2.test(u = numPredictors, v = df_error, f2 = f2, sig.level = alpha)
    
power_results <- rbind(power_results, data.frame(Outcome = outcome, Predictor = predictor, R2 = R2, f2 = f2, v = df_error, u = numPredictors,Power = power_result$power))}}




desktop_path <- "C:/Users/YourUsername/Desktop/power_analysis_results.csv"
desktop_path <- gsub("YourUsername", Sys.getenv("USERNAME"), desktop_path)
write.csv(power_results, file = desktop_path, row.names = FALSE)

```

##Power Analysis Model 2


```{r}

# Load necessary libraries
library(pwr)  # For power analysis

# Load necessary library
library(dplyr)

# Assume data3 is your dataset
# Rename columns
data3 <- data3 %>%
  rename(
    BlueBY = BlueB.Y,
    BlueRG = BlueR.G,
    RedBY = RedB.Y,
    RedRG = RedR.G
  )


# Define outcomes and predictors
outcomes <- c("BlueLUM", "BlueBY", "BlueRG", "RedLUM", "RedBY", "RedRG")
predictors <- c("COPcount", "PRcount", "MRcount","Ordinal")

# Initialize a data frame to store results
power_results <- data.frame(Outcome = character(),
                            Predictor = character(),
                            R2 = numeric(),
                            f2 = numeric(),
                            v = numeric(),  # Degrees of freedom for error term
                            u = numeric(),  # Number of predictors
                            Power = numeric(),
                            stringsAsFactors = FALSE)

# Set alpha and degrees of freedom for the error term (v = 15)
alpha <- 0.05  # Significance level


# Loop over each combination of outcome and predictor
for (outcome in outcomes) {
  for (predictor in predictors) {
    # Fit the linear model for the current combination
    model <- lm(as.formula(paste(outcome, "~", predictor)), data = data3)
    
    # Extract R-squared value
    R2 <- summary(model)$r.squared
    
    # Calculate Cohen's fÂ²
    f2 <- R2 / (1 - R2)
    
    df_error <- summary(model)$df[2]
    
    # Number of predictors (u) in the model
    numPredictors <- 1  # Only one predictor in each model
    
    # Perform power analysis (solve for power)
    power_result <- pwr.f2.test(u = numPredictors, v = df_error, f2 = f2, sig.level = alpha)
    
    # Store the results in the data frame
    power_results <- rbind(power_results, data.frame(Outcome = outcome,
                                                     Predictor = predictor,
                                                     R2 = R2,
                                                     f2 = f2,
                                                     v = df_error,
                                                     u = numPredictors,
                                                     Power = power_result$power))
  }
}



desktop_path <- "C:/Users/ksnyder/Desktop/power_analysis_results_data3.csv"
write.csv(power_results, file = desktop_path, row.names = FALSE)

```


## Predictor/Outcome correlations Aug 21
```{r}

library(stats)
library(dplyr)


predictors <- c("BlueLUM", "BlueBY", "BlueRG", "RedLUM", "RedBY", "RedRG")
outcomes <- c("Ordinal", "Prevalence", "Richness", "ARMEAN", "GCMEAN")

# Initialize a data frame to store results
results <- data.frame(Predictor = character(),
                      Outcome = character(),
                      Correlation = numeric(),
                      Uncorrected_p = numeric(),
                      BH_p = numeric(),
                      stringsAsFactors = FALSE)

# Loop over each combination of predictor and outcome
for (pred in predictors) {
  for (out in outcomes) {
    # Calculate Spearman correlation and p-value
    test_result <- cor.test(data6[[pred]], data6[[out]], method = "spearman", use = "complete.obs")
    
    # Add the results to the results data frame
    results <- rbind(results, data.frame(Predictor = pred,
                                         Outcome = out,
                                         Correlation = test_result$estimate,
                                         Uncorrected_p = test_result$p.value,
                                         BH_p = NA)) # Initialize BH_p as NA
  }
}

# Additional correlations to calculate
additional_pairs <- list(
  c("ARMEAN", "Prevalence"),
  c("ARMEAN", "Richness"),
  c("GCMEAN", "Prevalence"),
  c("GCMEAN", "Richness"),
  c("GCMEAN", "ARMEAN")
)

# Loop over additional pairs
for (pair in additional_pairs) {
  pred <- pair[1]
  out <- pair[2]
  
  # Calculate Spearman correlation and p-value
  test_result <- cor.test(data6[[pred]], data6[[out]], method = "spearman", use = "complete.obs")
  
  # Add the results to the results data frame
  results <- rbind(results, data.frame(Predictor = pred,
                                       Outcome = out,
                                       Correlation = test_result$estimate,
                                       Uncorrected_p = test_result$p.value,
                                       BH_p = NA)) # Initialize BH_p as NA
}

# Apply Benjamini-Hochberg correction to p-values
results$BH_p <- p.adjust(results$Uncorrected_p, method = "BH")


desktop_path <- "C:/Users/ksnyder/Desktop/correlations.csv"
write.csv(results, file = desktop_path, row.names = FALSE)


```


##Intramale Analyses


```{r}
library(vegan)
library(tidyverse)
library(RColorBrewer)


##Load data


STDATA<-read.csv("Intramale_ST.csv")
LTDATA<-read.csv("Intramale_LT.csv")


```



##Short Term with Benjamini-Hochberg correction
```{r}
# Load necessary libraries
if (!require("Hmisc")) install.packages("Hmisc", dependencies=TRUE)
library(Hmisc)

# Select the relevant columns
variables <- c('BLUMST', 'BBYST', 'BRGST', 'RLUMST', 'RBYST', 'RRGST', 'ORDST', 'PREVST', 'RCHST', 'GCST', 'ARST')
STDATA_selected <- STDATA[, variables]

# Calculate the Spearman correlation matrix
correlation_matrix <- rcorr(as.matrix(STDATA_selected), type = "spearman")

# Extract the p-values
p_values <- correlation_matrix$P

# Apply Benjamini-Hochberg correction
p_values_corrected_bh <- p.adjust(p_values, method = "BH")

# Reshape the corrected p-values back into a matrix
p_values_corrected_matrix_bh <- matrix(p_values_corrected_bh, nrow = length(variables), ncol = length(variables))
dimnames(p_values_corrected_matrix_bh) <- list(variables, variables)


print("Spearman Correlation Matrix:")
print(correlation_matrix$r)
print("Corrected P-Values Matrix (BH):")
print(p_values_corrected_matrix_bh)



##CSV to Desktop:

combined_matrix <- cbind(as.data.frame(correlation_matrix$r), as.data.frame(p_values_corrected_matrix_bh))
colnames(combined_matrix) <- paste0(rep(variables, 2), "_", rep(c("Corr", "PValue"), each = length(variables)))

file_path <- "C:/Users/ksnyder/Desktop/RIICorrs.csv"

write.csv(combined_matrix, file = file_path, row.names = TRUE)

```


##Long term with Benjamini-Hochberg correction

```{r}

# List of expected columns for LTDATA
variables_lt <- c('BLUMLT', 'BBYLT', 'BRGLT', 'RLUMLT', 'RBYRT', 'RRGLT', 'ORDLT', 'GCLT', 'ARLT')
LTDATA_selected <- LTDATA[, variables_lt]

# Calculate the Spearman correlation matrix
correlation_matrix_lt <- rcorr(as.matrix(LTDATA_selected), type = "spearman")

# Extract the p-values
p_values_lt <- correlation_matrix_lt$P

# Apply Benjamini-Hochberg correction
p_values_corrected_bh_lt <- p.adjust(p_values_lt, method = "BH")

# Reshape the corrected p-values back into a matrix
p_values_corrected_matrix_bh_lt <- matrix(p_values_corrected_bh_lt, nrow = length(variables_lt), ncol = length(variables_lt))
dimnames(p_values_corrected_matrix_bh_lt) <- list(variables_lt, variables_lt)

# Print the correlation matrix and the corrected p-values matrix
print("Spearman Correlation Matrix:")
print(correlation_matrix_lt$r, digits=2)
print("Corrected P-Values Matrix (BH):")
print(p_values_corrected_matrix_bh_lt)

##CSV to Desktop:


combined_matrix_lt <- cbind(as.data.frame(correlation_matrix_lt$r), as.data.frame(p_values_corrected_matrix_bh_lt))
colnames(combined_matrix_lt) <- paste0(rep(variables_lt, 2), "_", rep(c("Corr", "PValue"), each = length(variables_lt)))
file_path_lt <- "C:/Users/ksnyder/Desktop/RIICorrsLT.csv"
write.csv(combined_matrix_lt, file = file_path_lt, row.names = TRUE)


```


